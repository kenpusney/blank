<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock</title>
</head>
<body>
    <table border="0">
        <tr>
            <td><label>当前股价 Price</label></td>
            <td><input type="number" name="price" step="0.01"></td>
        </tr>
        <tr>
            <td><label>交易量 Amount （股）</label></td>
            <td><input type="number" name="amount" step="100"></td>
        </tr>
        <tr>
            <td><label>市场 Market</label></td>
            <td><select name="market" id="market">
                <option value="SHA" selected>沪市</option>
                <option value="SHE">深市</option>
            </select></td>
        </tr>
        <tr>
            <td><label>佣金费率 Commission Rate （‰）</label></td>
            <td><input type="number" name="commission_rate" value="0.3"></td>
        </tr>
        <tr>
            <td></td>
            <td><button id="calculate">计算</button>&nbsp;<button id="reset">重置</button></td>
        </tr>
    </table>
    <div id="result"></div>
    <script>
        function tryGetValue(name, label) {
            const value = document.querySelector(`[name='${name}']`).value;
            if (name == "market") {
                if (value == "SHA") {
                    return 0.01;
                }
                return 0;
            }
            try {
                return parseFloat(value);
            } catch(e) {
                alert(`Error: 输入数据格式不正确 ${label}`);
            }
        }

        const reserve = (number) => (Math.round(number * 100) / 100).toFixed(2)

        function calculateFees() {
            const price = tryGetValue("price", "股价");
            const amount = tryGetValue("amount", "交易量");
            const marketRate = tryGetValue("market", "市场");
            const commissionRate = tryGetValue("commission_rate", "佣金费率");
            const taxRate = 0.5;

            const totalPrice = price * amount;
            const commission = Math.max(5, totalPrice * commissionRate / 1000);
            const transferFee = totalPrice * marketRate / 1000;
            const tax = totalPrice * taxRate / 1000;
            const buyInCost = commission + transferFee;
            const saleOutCost = commission + transferFee + tax;
            document.querySelector("#result").innerHTML = `
                <dl>
                    <dt>成交价 Total</dt>
                    <dd>${reserve(totalPrice)}</dd>
                    <dt>佣金 Commission</dt>
                    <dd>${reserve(commission)}</dd>
                    <dt>过户费 Transfer Fee</dt>
                    <dd>${reserve(transferFee)}</dd>
                    <dt>印花税（仅卖出） Tax</dt>
                    <dd>${reserve(tax)}</dd>
                    <dt>买入总花费 Buy In Cost</dt>
                    <dd>${reserve(totalPrice + buyInCost)} (+ ${reserve(buyInCost)})</dd>
                    <dt>卖出总收益 Sale Out Income</dt>
                    <dd>${reserve(totalPrice - saleOutCost)} (- ${reserve(saleOutCost)})</dd>
                </dl>
            `
        }   

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelector("#calculate").addEventListener("click", calculateFees);
        })
    </script>
</body>
</html>